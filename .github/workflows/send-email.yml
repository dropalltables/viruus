name: Send Blog Post Email

on:
  push:
    branches:
      - main
    paths:
      - 'content/blog/**'

jobs:
  send-email:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect new files
      
      - name: Send email for new blog posts
        env:
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          RESEND_SEGMENT_ID: ${{ secrets.RESEND_SEGMENT_ID }}
        run: |
          #!/bin/bash
          set -e
          
          echo "Checking for new blog posts..."
          echo ""
          
          # Get list of newly added files in content/blog/
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep '^content/blog/.*\.md$' | grep -v '_index.md' || true)
          
          if [ -z "$NEW_FILES" ]; then
            echo "No new blog posts found."
            exit 0
          fi
          
          echo "Found new blog post(s):"
          echo "$NEW_FILES"
          echo ""
          
          EMAILS_SENT=0
          EMAILS_SKIPPED=0
          
          # Process each new file
          while IFS= read -r file; do
            if [ -z "$file" ]; then
              continue
            fi
            
            echo "Processing: $file"
            
            # Check if file exists
            if [ ! -f "$file" ]; then
              echo "  Skipping: File not found"
              echo ""
              EMAILS_SKIPPED=$((EMAILS_SKIPPED + 1))
              continue
            fi
            
            # Extract frontmatter and content
            CONTENT=$(cat "$file")
            
            # Check if file has frontmatter
            if ! echo "$CONTENT" | head -n 1 | grep -q "^+++"; then
              echo "  Skipping: No frontmatter found"
              echo ""
              EMAILS_SKIPPED=$((EMAILS_SKIPPED + 1))
              continue
            fi
            
            # Extract frontmatter (between first and second +++)
            FRONTMATTER=$(echo "$CONTENT" | awk '/^\+\+\+$/{if(++n==2)exit;next}n')
            
            # Extract post content (after second +++)
            POST_CONTENT=$(echo "$CONTENT" | awk '/^\+\+\+$/{n++; next} n>=2')
            
            # Check if draft
            IS_DRAFT=$(echo "$FRONTMATTER" | grep -i "^draft\s*=\s*true" || true)
            
            if [ -n "$IS_DRAFT" ]; then
              echo "  Skipping: Post is marked as draft"
              echo ""
              EMAILS_SKIPPED=$((EMAILS_SKIPPED + 1))
              continue
            fi
            
            # Extract title (handle both quoted and unquoted)
            TITLE=$(echo "$FRONTMATTER" | grep "^title\s*=" | head -n 1 | sed 's/^title\s*=\s*//' | sed 's/^"\(.*\)"$/\1/' | sed "s/^'\(.*\)'$/\1/")
            
            if [ -z "$TITLE" ]; then
              TITLE="Untitled Post"
            fi
            
            echo "  Title: $TITLE"
            
            # Convert markdown to HTML using pandoc
            POST_HTML=$(echo "$POST_CONTENT" | pandoc -f markdown -t html)
            
            # Escape content for JSON
            POST_HTML_ESCAPED=$(echo "$POST_HTML" | jq -Rs .)
            
            # Create JSON payload
            JSON_PAYLOAD=$(jq -n \
              --arg segment_id "$RESEND_SEGMENT_ID" \
              --arg from "dropalltables <blog@system.viruus.zip>" \
              --arg name "$TITLE" \
              --arg subject "$TITLE" \
              --argjson html "$POST_HTML_ESCAPED" \
              '{
                segment_id: $segment_id,
                from: $from,
                name: $name,
                subject: $subject,
                html: $html
              }')
            
            # Create broadcast via Resend API
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.resend.com/broadcasts" \
              -H "Authorization: Bearer $RESEND_API_KEY" \
              -H "Content-Type: application/json" \
              -d "$JSON_PAYLOAD")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
            RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
              BROADCAST_ID=$(echo "$RESPONSE_BODY" | jq -r '.id // "unknown"')
              echo "  Broadcast created: $BROADCAST_ID"
              
              # Send the broadcast
              SEND_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.resend.com/broadcasts/$BROADCAST_ID/send" \
                -H "Authorization: Bearer $RESEND_API_KEY")
              
              SEND_HTTP_CODE=$(echo "$SEND_RESPONSE" | tail -n 1)
              
              if [ "$SEND_HTTP_CODE" = "200" ] || [ "$SEND_HTTP_CODE" = "201" ]; then
                echo "  Email sent successfully"
                EMAILS_SENT=$((EMAILS_SENT + 1))
              else
                SEND_RESPONSE_BODY=$(echo "$SEND_RESPONSE" | head -n -1)
                echo "  Error sending broadcast (HTTP $SEND_HTTP_CODE)"
                echo "  Response: $SEND_RESPONSE_BODY"
                EMAILS_SKIPPED=$((EMAILS_SKIPPED + 1))
              fi
            else
              echo "  Error creating broadcast (HTTP $HTTP_CODE)"
              echo "  Response: $RESPONSE_BODY"
              EMAILS_SKIPPED=$((EMAILS_SKIPPED + 1))
            fi
            
            echo ""
          done <<< "$NEW_FILES"
          
          echo "Summary: $EMAILS_SENT email(s) sent, $EMAILS_SKIPPED skipped"
          exit 0
